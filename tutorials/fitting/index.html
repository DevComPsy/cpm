<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Fitting your models to data - CPM library</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Fitting your models to data";
        var mkdocs_page_input_path = "tutorials/fitting.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/markdown.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/makefile.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> CPM library
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../about/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../roadmap/">Roadmap</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guide</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../getting-started/">Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../data-format/">Data formats</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../parameters/">Specify your parameters</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../defining-model/">Build your model</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Fitting your models to data</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#optimisation">Optimisation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#extracting-parameters">Extracting Parameters</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#parallel-computing-on-windows">Parallel computing on Windows</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#walkthrough">Walkthrough</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#importerror-dll-load-failed-while-importing-arrays-the-paging-file-is-too-small-for-this-operation-to-complete-python-multiprocess">ImportError: DLL load failed while importing arrays: The paging file is too small for this operation to complete. python multiprocess</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Examples</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/example1/">Example 1: An associative learning model and blocking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/example2/">Example 2: Reinforcement learning with a two-armed bandit.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/example3/">Example 3: Estimating Empirical Priors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/example4/">Example 4: Scaling to the cluster</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../references/applications/">cpm.applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../references/models/">cpm.models</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../references/generators/">cpm.generators</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../references/optimisation/">cpm.optimisation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../references/hierarchical/">cpm.hierarchical</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../references/utils/">cpm.utils</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">CPM library</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">User Guide</li>
      <li class="breadcrumb-item active">Fitting your models to data</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="fitting-your-models-to-data">Fitting your models to data</h1>
<p>Once you have specified your model and set up your parameters, you want to fit the model to your data.
<code>cpm</code> offers a set of optimisation techniques, a non-exhaustive list of some commonly used ones in Computational Psychiatry.
The main advantage of <code>cpm</code> here is that it takes the assumption that you want to fit the model to each subject's data separately, and that you want to fit the model to multiple subjects at once.
<code>cpm</code> covers most of the data cleaning and compilation steps for you, so it frees up time to do the more creative work.</p>
<h2 id="optimisation">Optimisation</h2>
<p>All optimisation routines already implemented will be found in the <code>cpm.optimisation</code> module, whereas <code>cpm.optimisation.minimise</code> handles all likelihood functions</p>
<pre><code class="language-python">from cpm.optimisation import DifferentialEvolution, minimise

genetic = DifferentialEvolution(
    model=wrapped_model, # Wrapper class with the model we specified from before
    data=experiment, # the data as a list of dictionaries
    minimisation=minimise.LogLikelihood.bernoulli,
    parallel=True,
    ppt_identifier=&quot;ppt&quot;,
    display=False,
    maxiter=400, # additional arguments passed to scipy.optimise.differential_evolution
    tol=1e-10, # additional arguments passed to scipy.optimise.differential_evolution
)
</code></pre>
<p>There are a few things to note here.
First, you don't define bounds for the parameter space.
The reason for this is that you already defined bounds in the Parameter class for your model.
Bounds are part of the model specification and you will have to explicitly state them when you are building the model.
The second is that everything at the end that is not part of the named list of arguments for <code>cpm.optimisation.DifferentialEvolution</code> will be passed on the <code>scipy.optimize.differential_evolution</code> function.
<code>cpm</code> tries to avoid implementing methods from scratch, which is why we use <code>scipy</code> for the optimisation routines, and write most of the codebase with the intent on handling data cleaning and processing challenges.</p>
<h3 id="extracting-parameters">Extracting Parameters</h3>
<p>Once the optimisation is done, you can extract the parameters from the optimisation object.
Here, you will have two options: <code>genetic.export()</code> and <code>genetic.parameters</code>.
The former will return a pandas DataFrame with the optimisation data, whereas the latter will return the parameters as a list dictionary.
You can use <code>genetic.export()</code> to save the optimisation data to a .csv file and do everything you would want to do with a pandas DataFrame.
<code>genetic.parameters</code> is useful if you want to use the parameters for further simulations or analyses.
You can directly feed it to the <code>cpm.generators.Simulator</code> class to simulate:</p>
<pre><code class="language-python">simulation = Simulator(
    wrapper=wrapped_model, parameters=genetic.parameters, data=experiment
)
simulation.run()
simulation_results = simulation.export() # export the simulation results to a pandas DataFrame
simulation_results.to_csv(&quot;simulation.csv&quot;, index=False) # save the simulation results to a .csv file
</code></pre>
<h2 id="parallel-computing-on-windows">Parallel computing on Windows</h2>
<p>Issue<a href="https://github.com/DevComPsy/modelling-toolbox/issues/16">#16</a> is a known issue with Windows and parallelisation.
The way to circumvent this is to wrap your code in into <code>if __name__ == '__main__':</code> and load the parallelised optimisation bits as separate modules.</p>
<h3 id="walkthrough">Walkthrough</h3>
<p>Assume that you have the following folder structure:</p>
<pre><code class="language-bash">
```bash
project_name/
├── docs/
│   ├── lab_report.ipynb
│   └── data/
│       └── big_data_file.csv
├── src/
│   ├── main.py
│   └── utils/
│       ├── __init__.py
│       ├── setup_model.py
│       └── fitting.py
└── README.md
</code></pre>
<p>Feel free to adjust this structure based on your specific project needs.
fitting.py and setup_model.py are the files that contain the fitting and model setup functions, respectively.</p>
<p>For setup_model.py, you can structure it as follows:</p>
<pre><code class="language-python">def model_setup(data):
    &quot;&quot;&quot;
    The following function sets up the model.

    Parameters
    ----------
    data : list
        The data as a list of dictionaries.

    Return
    ------
    parameters : cpm.generators.Parameters
        The parameter object for the model
    wrapper : cpm.generators.Wrapper
        The Wrapper object with the model specified below.
    &quot;&quot;&quot;

    from cpm.models import learning, decision
    from cpm.generators import Value, Parameters, Wrapper
    import numpy as np

    parameters = Parameters(
        # ... your parameters here
    )

    def model(parameters, trial):
        # ... your model code here
        return output

    wrapper = Wrapper(model=model, parameters=parameters, data=data)

    print(wrapper)

    return parameters, wrapper
</code></pre>
<p>Your <code>fitting.py</code> file can be structured as follows:</p>
<pre><code class="language-python">def fitting(wrapper, experiment):
    &quot;&quot;&quot;
    The following function is used to fit the model to the data using the Differential Evolution algorithm. The function also saves the optimisation data and the simulation data as .csv files.

    Parameters
    ----------
    wrapper : cpm.generators.Wrapper
        The wrapper class with the model we specified from before.
    experiment : list
        The data as a list of dictionaries.

    Returns
    -------
    data : pandas.DataFrame
        The optimisation data.
    &quot;&quot;&quot;

    from cpm.optimisation import minimise, DifferentialEvolution
    from cpm.generators import Wrapper, Simulator, Parameters
    import pickle as pkl

    genetic = DifferentialEvolution(
        model=wrapper,  # Wrapper class with the model we specified from before
        data=experiment,  # the data as a list of dictionaries
        minimisation=minimise.LogLikelihood.bernoulli,
        # ... additional arguments go here
    )

    genetic.optimise()

    data = genetic.export()
    data.to_csv(&quot;optimisation.csv&quot;, index=False) # make sure to save stuff

    simulation = Simulator(
        wrapper=wrapper, parameters=genetic.parameters, data=experiment
    )
    simulation.run()

    simulation_data = simulation.export()
    simulation_data.to_csv(&quot;simulation.csv&quot;, index=False) # make sure to save stuff

    return data

</code></pre>
<p><strong>The important part is that you have a <code>main.py</code> file that will be the entry point for your project.</strong>
You can structure your <code>main.py</code> as follows:</p>
<pre><code class="language-python">if __name__ == &quot;__main__&quot;:
    import sys
    import os
    import time
    import pandas as pd
    from cpm.utils import pandas_to_dict
    from pickle import load

    # get the directory of the current file, and add to sys.path if necessary
    current_dir = os.path.dirname(os.path.abspath(__file__))
    if current_dir not in sys.path:
        sys.path.append(current_dir)

    print(&quot;Importing data&quot;)

    file_path = r&quot;some_data_file.csv&quot;

    experiment = pd.read_csv(file_path)
    experiment.head(10)

    experiment = experiment.astype(int)

    environment = pandas_to_dict(
        experiment,
        participant=&quot;ppt&quot;,
        stimuli=&quot;Stim&quot;,
        feedback=&quot;Feedback&quot;,
        observed=&quot;Response&quot;,
        trial_number=&quot;trial&quot;,
    )

    from utils.model import model_setup
    from utils.fitting import fitting

    print(&quot;\nSetting up model&quot;)
    # model_setup is a function that returns a cpm.generators.Parameters and a cpm.generators.Wrapper object
    parameters, learning_model = model_setup(environment[0])

    # time to fit the model
    start = time.time()

    print(f&quot;\n {start} : Fitting model&quot;)
    # fitting is a function that returns a pandas dataframe with the fitted parameters and other information
    output = fitting(learning_model, environment)
    end = time.time()
    print(f&quot;\n {end} : Model fitted in {end - start} seconds&quot;)
</code></pre>
<p>If you have this sorted, you can execute the <code>main.py</code> file from the command line, and the parallelisation should work as expected.</p>
<pre><code class="language-bash">python src/main.py
</code></pre>
<h3 id="importerror-dll-load-failed-while-importing-arrays-the-paging-file-is-too-small-for-this-operation-to-complete-python-multiprocess">ImportError: DLL load failed while importing arrays: The paging file is too small for this operation to complete. python multiprocess</h3>
<p>This error is due to the fact that the Windows operating system has a limit on the number of processes that can be spawned.
Possible solution are (1) to increase the size of the paging file; (2) to decrease the number of processes spawned; or (3) to use a different operating system via <code>docker</code>.
<code>cpm</code> provides a ready-to-ue <code>docker</code> container via <a href="https://hub.docker.com/repository/docker/lenarddome/dcp-cpm-latest-dev/general">DockerHub</a>, which you can use to run your code.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../defining-model/" class="btn btn-neutral float-left" title="Build your model"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../troubleshooting/" class="btn btn-neutral float-right" title="Troubleshooting">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../defining-model/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../troubleshooting/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
